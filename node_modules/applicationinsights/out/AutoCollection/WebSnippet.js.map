{"version":3,"file":"WebSnippet.js","sourceRoot":"","sources":["../../AutoCollection/WebSnippet.ts"],"names":[],"mappings":"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","sourcesContent":["import http = require(\"http\");\r\nimport https = require(\"https\");\r\nimport zlib = require(\"zlib\");\r\n\r\nimport Logging = require(\"../Library/Logging\");\r\nimport TelemetryClient = require(\"../Library/TelemetryClient\");\r\nimport snippetInjectionHelper = require(\"../Library/SnippetInjectionHelper\");\r\nimport Statsbeat = require(\"./Statsbeat\");\r\nimport Constants = require(\"../Declarations/Constants\");\r\nimport ConnectionStringParser = require(\"../Library/ConnectionStringParser\");\r\nimport {webSnippet} from \"@microsoft/applicationinsights-web-snippet\";\r\n\r\nclass WebSnippet {\r\n\r\n    public static INSTANCE: WebSnippet;\r\n\r\n    private static _snippet: string;\r\n    private static _aiUrl: string;\r\n    private static _aiDeprecatedUrl: string;\r\n    private _isEnabled: boolean;\r\n    private _isInitialized: boolean;\r\n    private _isIkeyValid: boolean = true;\r\n    private _statsbeat: Statsbeat;\r\n    \r\n\r\n    constructor(client: TelemetryClient) {\r\n        if (!!WebSnippet.INSTANCE) {\r\n            throw new Error(\"Web snippet injection should be configured from the applicationInsights object\");\r\n        }\r\n\r\n        WebSnippet.INSTANCE = this;\r\n        // AI URL used to validate if snippet already included\r\n        WebSnippet._aiUrl = \"https://js.monitor.azure.com/scripts/b/ai\";\r\n        WebSnippet._aiDeprecatedUrl = \"https://az416426.vo.msecnd.net/scripts/b/ai\";\r\n\r\n        let clientSnippetConnectionString = client.config.webSnippetConnectionString;\r\n        let defaultIkey = client.config.instrumentationKey;\r\n        if (!!clientSnippetConnectionString) {\r\n            let clientSnippetIkey = this._getWebSnippetIkey(client.config.webSnippetConnectionString);\r\n            defaultIkey = clientSnippetIkey;\r\n        }\r\n\r\n        WebSnippet._snippet = webSnippet.replace(\"INSTRUMENTATION_KEY\", defaultIkey);\r\n        this._statsbeat = client.getStatsbeat();\r\n      \r\n    }\r\n\r\n    public enable(isEnabled: boolean, webSnippetConnectionString?: string ) {\r\n        this._isEnabled = isEnabled;\r\n        if (!!webSnippetConnectionString) {\r\n            let iKey = this._getWebSnippetIkey(webSnippetConnectionString);\r\n            WebSnippet._snippet = webSnippet.replace(\"INSTRUMENTATION_KEY\", iKey);\r\n        }\r\n        if (this._isEnabled && !this._isInitialized && this._isIkeyValid) {\r\n            if (this._statsbeat) {\r\n                this._statsbeat.addFeature(Constants.StatsbeatFeature.WEB_SNIPPET);\r\n            }\r\n            this._initialize();\r\n        } else if (!this._isEnabled) {\r\n            if (this._statsbeat) {\r\n                this._statsbeat.removeFeature(Constants.StatsbeatFeature.WEB_SNIPPET);\r\n            }\r\n        }\r\n    }\r\n\r\n    public isInitialized() {\r\n        return this._isInitialized;\r\n    }\r\n\r\n    private _getWebSnippetIkey(connectionString: string) {\r\n        const csCode = ConnectionStringParser.parse(connectionString);\r\n        const iKeyCode = csCode.instrumentationkey || \"\";\r\n        if (!ConnectionStringParser.isIkeyValid(iKeyCode)) {\r\n            this._isIkeyValid = false;\r\n            Logging.info(\"Invalid web snippet connection string, web snippet will not be injected.\");\r\n        }\r\n        return iKeyCode;\r\n    }\r\n\r\n    private _initialize() {\r\n        this._isInitialized = true;\r\n        const originalHttpServer = http.createServer;\r\n        const originalHttpsServer = https.createServer;\r\n        var isEnabled = this._isEnabled;\r\n\r\n        http.createServer = (requestListener?: (request: http.IncomingMessage, response: http.ServerResponse) => void) => {\r\n            const originalRequestListener = requestListener;\r\n            if (originalRequestListener) {\r\n                requestListener = (request: http.IncomingMessage, response: http.ServerResponse) => {\r\n                    // Patch response write method\r\n                    let originalResponseWrite = response.write;\r\n                    let isGetRequest = request.method == \"GET\";\r\n                    response.write = function wrap(a: Buffer | string, b?: Function | string, c?:  Function | string) {\r\n                        //only patch GET request\r\n                        try {\r\n                            if (isEnabled && isGetRequest) {\r\n                                let headers =  snippetInjectionHelper.getContentEncodingFromHeaders(response);\r\n                                let writeBufferType = undefined;\r\n                                if (typeof b === \"string\") {\r\n                                    writeBufferType = b;\r\n                                }\r\n                                if (headers === null || headers === undefined) {\r\n                                    if (WebSnippet.INSTANCE.ValidateInjection(response, a)) {\r\n                                        arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(response, a, undefined, writeBufferType);\r\n                                    }\r\n                                } else if (headers.length) {\r\n                                    let encodeType = headers[0];\r\n                                    arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(response, a, encodeType);\r\n                                }\r\n                            }\r\n                        } catch (err) {\r\n                            Logging.warn(\"Inject snippet error: \"+ err);\r\n                        }\r\n                        return originalResponseWrite.apply(response, arguments);\r\n                    }\r\n\r\n                    // Patch response end method for cases when HTML is added there\r\n                    let originalResponseEnd = response.end;\r\n\r\n                    response.end = function wrap(a?: Buffer | string | any, b?: Function | string, c?: Function) {\r\n                        if (isEnabled && isGetRequest) {\r\n                            try {\r\n                                if (isEnabled && isGetRequest) {\r\n                                    let headers =  snippetInjectionHelper.getContentEncodingFromHeaders(response);\r\n                                    let endBufferType = undefined;\r\n                                    if (typeof b === \"string\") {\r\n                                        endBufferType = b;\r\n                                    }\r\n                                    if (headers === null || headers === undefined) {\r\n                                        if (WebSnippet.INSTANCE.ValidateInjection(response, a)) {\r\n                                            arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(response, a, undefined, endBufferType);\r\n                                        }\r\n                                    } else if (headers.length) {\r\n                                        let encodeType = headers[0];\r\n                                        arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(response, a, encodeType);\r\n                                    }\r\n                                }\r\n                            } catch (err) {\r\n                                Logging.warn(\"Inject snipet error: \"+ err);\r\n                            }\r\n                        }\r\n                        return originalResponseEnd.apply(response, arguments);\r\n                    }\r\n\r\n                    return originalRequestListener(request, response);\r\n                }\r\n            }\r\n            return originalHttpServer(requestListener);\r\n        }\r\n\r\n        https.createServer = function(options,httpsRequestListener) {\r\n            const originalHttpsRequestListener = httpsRequestListener;\r\n            if (originalHttpsRequestListener) {\r\n                httpsRequestListener = function (req, res) {\r\n                    let isGetHttpsRequest = req.method == \"GET\";\r\n                    let originalHttpsResponseWrite = res.write;\r\n                    let originalHttpsResponseEnd = res.end;\r\n                    res.write = function wrap(a: Buffer | string | any, b?:Function | string, c?: Function) {\r\n                        try {\r\n                            if (isEnabled && isGetHttpsRequest) {\r\n                                let headers =  snippetInjectionHelper.getContentEncodingFromHeaders(res);\r\n                                let writeBufferType = undefined;\r\n                                if (typeof b === \"string\") {\r\n                                    writeBufferType = b;\r\n                                }\r\n                                if (headers === null || headers === undefined) {\r\n                                    if (WebSnippet.INSTANCE.ValidateInjection(res, a)) {\r\n                                        arguments[0] = this.InjectWebSnippet(res, a, undefined, writeBufferType);\r\n                                    }\r\n                                } else if (headers.length) {\r\n                                    let encodeType = headers[0];\r\n                                    arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(res, a, encodeType);\r\n                                }\r\n                            }\r\n                        } catch (err) {\r\n                            Logging.warn(\"Inject snippet error: \"+ err);\r\n                        }\r\n                        return originalHttpsResponseWrite.apply(res,arguments);\r\n                    }\r\n\r\n                    res.end = function wrap(a: Buffer | string | any, b?:Function | string, c?: Function) {\r\n                        try {\r\n                            if (isEnabled && isGetHttpsRequest) {\r\n                                let headers =  snippetInjectionHelper.getContentEncodingFromHeaders(res);\r\n                                let endBufferType = undefined;\r\n                                if (typeof b === \"string\") {\r\n                                    endBufferType = b;\r\n                                }\r\n                                if (headers === null || headers === undefined) {\r\n                                    if (WebSnippet.INSTANCE.ValidateInjection(res, a)) {\r\n                                        arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(res, a, undefined, endBufferType);\r\n                                    }\r\n                                } else if (headers.length) {\r\n                                    let encodeType = headers[0];\r\n                                    arguments[0] = WebSnippet.INSTANCE.InjectWebSnippet(res, a, encodeType);\r\n                                }\r\n                            }\r\n                        } catch (err) {\r\n                            Logging.warn(\"Inject snippet error: \"+ err);\r\n                        }\r\n                        return originalHttpsResponseEnd.apply(res,arguments);\r\n\r\n                    }\r\n                    return originalHttpsRequestListener(req,res);\r\n                }\r\n                return originalHttpsServer(options, httpsRequestListener);\r\n\r\n            }\r\n          \r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * Validate response and try to inject Web snippet\r\n     */\r\n    public ValidateInjection(response: http.ServerResponse, input: string | Buffer): boolean {\r\n\r\n        if (!response || !input || response.statusCode != 200) return false;\r\n        let isContentHtml =  snippetInjectionHelper.isContentTypeHeaderHtml(response);\r\n        if (!isContentHtml) return false;\r\n        let inputStr = input.slice().toString();\r\n        if (inputStr.indexOf(\"<head>\") >= 0 && inputStr.indexOf(\"</head>\") >= 0) {\r\n            // Check if snippet not already present looking for AI Web SDK URL\r\n            if (inputStr.indexOf(WebSnippet._aiUrl) < 0 && inputStr.indexOf(WebSnippet._aiDeprecatedUrl) < 0) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Inject Web snippet\r\n     */\r\n    public InjectWebSnippet(response: http.ServerResponse, input: string | Buffer, encodeType?: snippetInjectionHelper.contentEncodingMethod, bufferEncodeType?: string ): string | Buffer {\r\n        try {\r\n            let isCompressedBuffer = !!encodeType;\r\n            if (!isCompressedBuffer) {\r\n                let html = input.toString();\r\n                let index = html.indexOf(\"</head>\");\r\n                if (index < 0) return input;\r\n\r\n                let newHtml = snippetInjectionHelper.insertSnippetByIndex(index,html,WebSnippet._snippet);\r\n                if (typeof input === \"string\") {\r\n                    response.removeHeader(\"Content-Length\");\r\n                    input = newHtml;\r\n                    response.setHeader(\"Content-Length\", Buffer.byteLength(input));\r\n                } else if (Buffer.isBuffer(input)) {\r\n                    let bufferType = bufferEncodeType? bufferEncodeType:\"utf8\";\r\n                    let isValidBufferType = snippetInjectionHelper.isBufferType(input, bufferType);\r\n                    if (isValidBufferType) {\r\n                        response.removeHeader(\"Content-Length\");\r\n                        let encodedString = Buffer.from(newHtml).toString(bufferType);\r\n                        input = Buffer.from(encodedString,bufferType);\r\n                        response.setHeader(\"Content-Length\", input.length);\r\n                    }\r\n                }\r\n            } else {\r\n                response.removeHeader(\"Content-Length\");\r\n                input = this._getInjectedCompressBuffer(response,input as Buffer,encodeType);\r\n                response.setHeader(\"Content-Length\", input.length);\r\n            }\r\n        }\r\n        catch (ex) {\r\n            Logging.warn(\"Failed to inject web snippet and change content-lenght headers. Exception:\" + ex);\r\n        }\r\n        return input;\r\n    }\r\n\r\n    //***********************\r\n    // should NOT use sync functions here. But currently cannot get async functions to work\r\n    // because reponse.write return boolean\r\n    // and also this function do not support partial compression as well\r\n    // need more investigation\r\n    private _getInjectedCompressBuffer(response: http.ServerResponse, input: Buffer, encodeType: snippetInjectionHelper.contentEncodingMethod): Buffer {\r\n        switch (encodeType) {\r\n            case snippetInjectionHelper.contentEncodingMethod.GZIP:\r\n                let gunzipBuffer = zlib.gunzipSync(input);\r\n                if (this.ValidateInjection(response,gunzipBuffer)) {\r\n                    let injectedGunzipBuffer = this.InjectWebSnippet(response, gunzipBuffer);\r\n                    input = zlib.gzipSync(injectedGunzipBuffer);\r\n                 }\r\n                 break;\r\n            case snippetInjectionHelper.contentEncodingMethod.DEFLATE:\r\n                let inflateBuffer = zlib.inflateSync(input);\r\n                if (this.ValidateInjection(response,inflateBuffer)) {\r\n                    let injectedInflateBuffer = this.InjectWebSnippet(response, inflateBuffer);\r\n                    input = zlib.deflateSync(injectedInflateBuffer);\r\n                 }\r\n                 break;\r\n            case snippetInjectionHelper.contentEncodingMethod.BR:\r\n                let BrotliDecompressSync = snippetInjectionHelper.getBrotliDecompressSync(zlib);\r\n                let BrotliCompressSync = snippetInjectionHelper.getBrotliCompressSync(zlib);\r\n                if (BrotliDecompressSync && BrotliCompressSync) {\r\n                    let decompressBuffer = BrotliDecompressSync(input);\r\n                    if (this.ValidateInjection(response,decompressBuffer)) {\r\n                        let injectedDecompressBuffer = this.InjectWebSnippet(response, decompressBuffer);\r\n                        input = BrotliCompressSync(injectedDecompressBuffer);\r\n                     }\r\n                     break;\r\n                }\r\n        }\r\n\r\n        return input;\r\n    }\r\n\r\n    public dispose() {\r\n        WebSnippet.INSTANCE = null;\r\n        this.enable(false);\r\n        this._isInitialized = false;\r\n    }\r\n}\r\n\r\nexport = WebSnippet;\r\n"]}