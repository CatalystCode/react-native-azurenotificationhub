{"version":3,"file":"AsyncHooksScopeManager.js","sourceRoot":"","sources":["../../AutoCollection/AsyncHooksScopeManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAGA,yEAA2F;AAC3F,iCAAsC;AAEtC;IAAA;IAmEA,CAAC;IAhEU,iDAAM,GAAb;QAAA,iBAkBC;QAjBG,IAAM,OAAO,GAAG,qDAAyB,CAAC,iBAAiB,EAAS,CAAC;QACrE,6BACO,OAAO,KACV,QAAQ,EAAE,UAAC,GAAW;gBAClB,wDAAwD;gBACxD,IAAI,CAAC,KAAI,CAAC,aAAa,EAAE;oBACrB,KAAI,CAAC,aAAa,GAAG,GAAG,CAAC;oBACzB,OAAO,OAAO,CAAC;iBAClB;gBAED,IAAI,GAAG,KAAK,KAAI,CAAC,aAAa,EAAE;oBAC5B,OAAO,OAAO,CAAC;iBAClB;gBACD,OAAO,KAAK,CAAC;YACjB,CAAC,EACD,QAAQ,EAAE,cAAQ,CAAC,IACrB;IACN,CAAC;IAEM,+CAAI,GAAX,UAAY,IAAU,EAAE,EAAa;QACjC,IAAM,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACvC,IAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACvB,IAAM,kBAAkB,GAAG,gCAAgC,CAAC,cAAc,CAAC,IAAI,EAAE,YAAY,EAAE,IAAI,CAAC,CAAC;QACrG,OAAO,qDAAyB,CAAC,cAAc,CAAC,kBAAkB,EAAE,EAAE,CAAC,EAAE,CAAC;IAC9E,CAAC;IAEM,+CAAI,GAAX,UAAe,MAAS;QACpB,IAAI,OAAO,MAAM,KAAK,UAAU,EAAE;YAC9B,OAAO,qDAAyB,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;SACzD;aAAM,IAAI,MAAM,YAAY,qBAAY,EAAE;YACvC,qDAAyB,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;SACjD;QACD,OAAO,MAAM,CAAC;IAClB,CAAC;IAEM,iDAAM,GAAb;QACI,qDAAyB,CAAC,MAAM,EAAE,CAAC;QACnC,OAAO,IAAI,CAAC;IAChB,CAAC;IAEM,kDAAO,GAAd;QACI,qDAAyB,CAAC,OAAO,EAAE,CAAC;QACpC,OAAO,IAAI,CAAC;IAChB,CAAC;IAEc,+CAAc,GAA7B,UAA8B,IAAU,EAAE,YAAqB,EAAE,IAAa;QAC1E,IAAM,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC,CAAO,IAAK,CAAC,OAAO,EAAE,CAAC,CAAC,0CAA0C;QAC7H,IAAM,OAAO,yBACN,IAAI,CAAC,WAAW,EAAE,KACrB,UAAU,EAAE,IAAI,CAAC,WAAW,EAAE,CAAC,UAAU,GAC5C,CAAC;QACF,IAAI,QAAQ,GAAG,YAAY,CAAC,CAAC,CAAC,MAAI,WAAW,CAAC,OAAO,SAAI,YAAY,MAAG,CAAC,CAAC,CAAC,WAAW,CAAC,OAAO,CAAC;QAC/F,IAAM,SAAS,GAAG,qDAAyB,CAAC,iBAAiB,EAAE,CAAC;QAChE,IAAI,SAAS,EAAE;YACX,OAAO,CAAC,OAAO,GAAG,SAAS,CAAC,SAAS,CAAC,EAAE,CAAC;YACzC,gDAAgD;YAChD,IAAI,CAAC,YAAY,EAAE;gBACf,QAAQ,GAAG,SAAS,CAAC,SAAS,CAAC,QAAQ,CAAC;aAC3C;SACJ;QACD,IAAM,kBAAkB,GAAG,qDAAyB,CAAC,mBAAmB,CAAC,OAAO,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAA;QACjG,OAAO,kBAAkB,CAAC;IAC9B,CAAC;IACL,uCAAC;AAAD,CAAC,AAnED,IAmEC;AAnEY,4EAAgC;AAqEhC,QAAA,iBAAiB,GAAG,IAAI,gCAAgC,EAAE,CAAC","sourcesContent":["import { SpanContext } from \"@opentelemetry/api\";\r\nimport { Span } from \"@opentelemetry/sdk-trace-base\";\r\n\r\nimport { CorrelationContextManager, CorrelationContext } from \"./CorrelationContextManager\"\r\nimport { EventEmitter } from \"events\";\r\n\r\nexport class OpenTelemetryScopeManagerWrapper {\r\n    private _activeSymbol: symbol | undefined;\r\n\r\n    public active() {\r\n        const context = CorrelationContextManager.getCurrentContext() as any;\r\n        return {\r\n            ...context,\r\n            getValue: (key: symbol) => {\r\n                // todo: lazy import activeSymbol from opentelemetry/api\r\n                if (!this._activeSymbol) {\r\n                    this._activeSymbol = key;\r\n                    return context;\r\n                }\r\n\r\n                if (key === this._activeSymbol) {\r\n                    return context;\r\n                }\r\n                return false;\r\n            },\r\n            setValue: () => { }\r\n        };\r\n    }\r\n\r\n    public with(span: Span, fn: () => any) {\r\n        const parentSpanId = span.parentSpanId;\r\n        const name = span.name;\r\n        const correlationContext = OpenTelemetryScopeManagerWrapper._spanToContext(span, parentSpanId, name);\r\n        return CorrelationContextManager.runWithContext(correlationContext, fn)();\r\n    }\r\n\r\n    public bind<T>(target: T): T {\r\n        if (typeof target === \"function\") {\r\n            return CorrelationContextManager.wrapCallback(target);\r\n        } else if (target instanceof EventEmitter) {\r\n            CorrelationContextManager.wrapEmitter(target);\r\n        }\r\n        return target;\r\n    }\r\n\r\n    public enable(): this {\r\n        CorrelationContextManager.enable();\r\n        return this;\r\n    }\r\n\r\n    public disable(): this {\r\n        CorrelationContextManager.disable();\r\n        return this;\r\n    }\r\n\r\n    private static _spanToContext(span: Span, parentSpanId?: string, name?: string): CorrelationContext {\r\n        const spanContext = span.spanContext ? span.spanContext() : (<any>span).context(); // context is available in OT API <v0.19.0\r\n        const context: SpanContext = {\r\n            ...span.spanContext(),\r\n            traceFlags: span.spanContext().traceFlags\r\n        };\r\n        let parentId = parentSpanId ? `|${spanContext.traceId}.${parentSpanId}.` : spanContext.traceId;\r\n        const aiContext = CorrelationContextManager.getCurrentContext();\r\n        if (aiContext) {\r\n            context.traceId = aiContext.operation.id;\r\n            // If parent is no available use current context\r\n            if (!parentSpanId) {\r\n                parentId = aiContext.operation.parentId;\r\n            }\r\n        }\r\n        const correlationContext = CorrelationContextManager.spanToContextObject(context, parentId, name)\r\n        return correlationContext;\r\n    }\r\n}\r\n\r\nexport const AsyncScopeManager = new OpenTelemetryScopeManagerWrapper();\r\n"]}