{"version":3,"file":"JsonConfig.js","sourceRoot":"","sources":["../../Library/JsonConfig.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require(\"fs\");\r\nimport path = require(\"path\");\r\n\r\nimport Logging = require(\"./Logging\");\r\nimport { IJsonConfig } from \"../Declarations/Interfaces\";\r\nimport { DistributedTracingModes } from \"../applicationinsights\";\r\nimport { IDisabledExtendedMetrics } from \"../AutoCollection/NativePerformance\";\r\n\r\nconst ENV_CONFIGURATION_FILE = \"APPLICATIONINSIGHTS_CONFIGURATION_FILE\";\r\n// Azure Connection String\r\nconst ENV_connectionString = \"APPLICATIONINSIGHTS_CONNECTION_STRING\";\r\n// Instrumentation Key\r\nconst ENV_azurePrefix = \"APPSETTING_\"; // Azure adds this prefix to all environment variables\r\nconst ENV_instrumentationKey = \"APPINSIGHTS_INSTRUMENTATIONKEY\";\r\nconst ENV_legacyInstrumentationKey = \"APPINSIGHTS_INSTRUMENTATION_KEY\"\r\n// Native Metrics Opt Outs\r\nconst ENV_nativeMetricsDisablers = \"APPLICATION_INSIGHTS_DISABLE_EXTENDED_METRIC\";\r\nconst ENV_nativeMetricsDisableAll = \"APPLICATION_INSIGHTS_DISABLE_ALL_EXTENDED_METRICS\"\r\nconst ENV_http_proxy = \"http_proxy\";\r\nconst ENV_https_proxy = \"https_proxy\";\r\nconst ENV_noDiagnosticChannel = \"APPLICATION_INSIGHTS_NO_DIAGNOSTIC_CHANNEL\"\r\nconst ENV_noStatsbeat = \"APPLICATION_INSIGHTS_NO_STATSBEAT\";\r\nconst ENV_noHttpAgentKeepAlive = \"APPLICATION_INSIGHTS_NO_HTTP_AGENT_KEEP_ALIVE\";\r\nconst ENV_noPatchModules = \"APPLICATION_INSIGHTS_NO_PATCH_MODULES\";\r\nconst ENV_webSnippetEnable = \"APPLICATIONINSIGHTS_WEB_SNIPPET_ENABLED\";\r\nconst ENV_webSnippet_connectionString = \"APPLICATIONINSIGHTS_WEB_SNIPPET_CONNECTION_STRING\";\r\n\r\nexport class JsonConfig implements IJsonConfig {\r\n    private static _instance: JsonConfig;\r\n\r\n    public connectionString: string;\r\n    public instrumentationKey: string;\r\n    public endpointUrl: string;\r\n    public maxBatchSize: number;\r\n    public maxBatchIntervalMs: number;\r\n    public disableAppInsights: boolean;\r\n    public samplingPercentage: number;\r\n    public correlationIdRetryIntervalMs: number;\r\n    public correlationHeaderExcludedDomains: string[];\r\n    public proxyHttpUrl: string;\r\n    public proxyHttpsUrl: string;\r\n    public ignoreLegacyHeaders: boolean;\r\n    public distributedTracingMode: DistributedTracingModes;\r\n    public enableAutoCollectExternalLoggers: boolean;\r\n    public enableAutoCollectConsole: boolean;\r\n    public enableAutoCollectExceptions: boolean;\r\n    public enableAutoCollectPerformance: boolean;\r\n    public enableAutoCollectExtendedMetrics: boolean | IDisabledExtendedMetrics;\r\n    public enableAutoCollectPreAggregatedMetrics: boolean;\r\n    public enableAutoCollectHeartbeat: boolean;\r\n    public enableAutoCollectRequests: boolean;\r\n    public enableAutoCollectDependencies: boolean;\r\n    public enableAutoDependencyCorrelation: boolean;\r\n    public enableUseAsyncHooks: boolean;\r\n    public enableUseDiskRetryCaching: boolean;\r\n    public enableResendInterval: number;\r\n    public enableMaxBytesOnDisk: number;\r\n    public enableInternalDebugLogging: boolean;\r\n    public enableInternalWarningLogging: boolean;\r\n    public enableSendLiveMetrics: boolean;\r\n    public disableAllExtendedMetrics: boolean;\r\n    public extendedMetricDisablers: string;\r\n    public disableStatsbeat: boolean;\r\n    public noDiagnosticChannel: boolean;\r\n    public noPatchModules: string;\r\n    public noHttpAgentKeepAlive: boolean;\r\n    public quickPulseHost: string;\r\n    public enableAutoWebSnippetInjection: boolean;\r\n    public webSnippetConnectionString: string;\r\n\r\n    static getInstance() {\r\n        if (!JsonConfig._instance) {\r\n            JsonConfig._instance = new JsonConfig();\r\n        }\r\n        return JsonConfig._instance;\r\n    }\r\n\r\n    constructor() {\r\n        // Load env variables first\r\n        this.connectionString = process.env[ENV_connectionString];\r\n        this.instrumentationKey = process.env[ENV_instrumentationKey]\r\n            || process.env[ENV_azurePrefix + ENV_instrumentationKey]\r\n            || process.env[ENV_legacyInstrumentationKey]\r\n            || process.env[ENV_azurePrefix + ENV_legacyInstrumentationKey];\r\n\r\n        if (!this.connectionString && this.instrumentationKey) {\r\n            Logging.warn(\"APPINSIGHTS_INSTRUMENTATIONKEY is in path of deprecation, please use APPLICATIONINSIGHTS_CONNECTION_STRING env variable to setup the SDK.\");\r\n        }\r\n        this.disableAllExtendedMetrics = !!process.env[ENV_nativeMetricsDisableAll];\r\n        this.extendedMetricDisablers = process.env[ENV_nativeMetricsDisablers];\r\n        this.proxyHttpUrl = process.env[ENV_http_proxy];\r\n        this.proxyHttpsUrl = process.env[ENV_https_proxy];\r\n        this.noDiagnosticChannel = !!process.env[ENV_noDiagnosticChannel];\r\n        this.disableStatsbeat = !!process.env[ENV_noStatsbeat];\r\n        this.noHttpAgentKeepAlive = !!process.env[ENV_noHttpAgentKeepAlive];\r\n        this.noPatchModules = process.env[ENV_noPatchModules] || \"\";\r\n        this.enableAutoWebSnippetInjection = !!process.env[ENV_webSnippetEnable];\r\n        this.webSnippetConnectionString = process.env[ENV_webSnippet_connectionString] || \"\";\r\n        this._loadJsonFile();\r\n    }\r\n\r\n    private _loadJsonFile() {\r\n        let configFileName = \"applicationinsights.json\";\r\n        let rootPath = path.join(__dirname, \"../../\"); // Root of applicationinsights folder (__dirname = ../out/Library)\r\n        let tempDir = path.join(rootPath, configFileName); // default\r\n        let configFile = process.env[ENV_CONFIGURATION_FILE];\r\n        if (configFile) {\r\n            if (path.isAbsolute(configFile)) {\r\n                tempDir = configFile;\r\n            }\r\n            else {\r\n                tempDir = path.join(rootPath, configFile);// Relative path to applicationinsights folder\r\n            }\r\n        }\r\n        try {\r\n            const jsonConfig: IJsonConfig = JSON.parse(fs.readFileSync(tempDir, \"utf8\"));\r\n            if (jsonConfig.disableStatsbeat != undefined) {\r\n                this.disableStatsbeat = jsonConfig.disableStatsbeat;\r\n            }\r\n            if (jsonConfig.disableAllExtendedMetrics != undefined) {\r\n                this.disableAllExtendedMetrics = jsonConfig.disableStatsbeat;\r\n            }\r\n            if (jsonConfig.noDiagnosticChannel != undefined) {\r\n                this.noDiagnosticChannel = jsonConfig.noDiagnosticChannel;\r\n            }\r\n            if (jsonConfig.noHttpAgentKeepAlive != undefined) {\r\n                this.noHttpAgentKeepAlive = jsonConfig.noHttpAgentKeepAlive;\r\n            }\r\n            if (jsonConfig.connectionString != undefined) {\r\n                this.connectionString = jsonConfig.connectionString;\r\n            }\r\n            if (jsonConfig.extendedMetricDisablers != undefined) {\r\n                this.extendedMetricDisablers = jsonConfig.extendedMetricDisablers;\r\n            }\r\n            if (jsonConfig.noDiagnosticChannel != undefined) {\r\n                this.noDiagnosticChannel = jsonConfig.noDiagnosticChannel;\r\n            }\r\n            if (jsonConfig.proxyHttpUrl != undefined) {\r\n                this.proxyHttpUrl = jsonConfig.proxyHttpUrl;\r\n            }\r\n            if (jsonConfig.proxyHttpsUrl != undefined) {\r\n                this.proxyHttpsUrl = jsonConfig.proxyHttpsUrl;\r\n            }\r\n            if (jsonConfig.proxyHttpsUrl != undefined) {\r\n                this.proxyHttpsUrl = jsonConfig.proxyHttpsUrl;\r\n            }\r\n            if (jsonConfig.noPatchModules != undefined) {\r\n                this.noPatchModules = jsonConfig.noPatchModules;\r\n            }\r\n            if (jsonConfig.enableAutoWebSnippetInjection != undefined) {\r\n                this.enableAutoWebSnippetInjection = jsonConfig.enableAutoWebSnippetInjection;\r\n            }\r\n\r\n            if (jsonConfig.webSnippetConnectionString != undefined) {\r\n                this.webSnippetConnectionString = jsonConfig.webSnippetConnectionString;\r\n            }\r\n\r\n            this.endpointUrl = jsonConfig.endpointUrl;\r\n            this.maxBatchSize = jsonConfig.maxBatchSize;\r\n            this.maxBatchIntervalMs = jsonConfig.maxBatchIntervalMs;\r\n            this.disableAppInsights = jsonConfig.disableAppInsights;\r\n            this.samplingPercentage = jsonConfig.samplingPercentage;\r\n            this.correlationIdRetryIntervalMs = jsonConfig.correlationIdRetryIntervalMs;\r\n            this.correlationHeaderExcludedDomains = jsonConfig.correlationHeaderExcludedDomains;\r\n            this.ignoreLegacyHeaders = jsonConfig.ignoreLegacyHeaders;\r\n            this.distributedTracingMode = jsonConfig.distributedTracingMode;\r\n            this.enableAutoCollectExternalLoggers = jsonConfig.enableAutoCollectExternalLoggers;\r\n            this.enableAutoCollectConsole = jsonConfig.enableAutoCollectConsole;\r\n            this.enableAutoCollectExceptions = jsonConfig.enableAutoCollectExceptions;\r\n            this.enableAutoCollectPerformance = jsonConfig.enableAutoCollectPerformance;\r\n            this.enableAutoCollectExtendedMetrics = jsonConfig.enableAutoCollectExtendedMetrics;\r\n            this.enableAutoCollectPreAggregatedMetrics = jsonConfig.enableAutoCollectPreAggregatedMetrics;\r\n            this.enableAutoCollectHeartbeat = jsonConfig.enableAutoCollectHeartbeat;\r\n            this.enableAutoCollectRequests = jsonConfig.enableAutoCollectRequests;\r\n            this.enableAutoCollectDependencies = jsonConfig.enableAutoCollectDependencies;\r\n            this.enableAutoDependencyCorrelation = jsonConfig.enableAutoDependencyCorrelation;\r\n            this.enableUseAsyncHooks = jsonConfig.enableUseAsyncHooks;\r\n            this.enableUseDiskRetryCaching = jsonConfig.enableUseDiskRetryCaching;\r\n            this.enableResendInterval = jsonConfig.enableResendInterval;\r\n            this.enableMaxBytesOnDisk = jsonConfig.enableMaxBytesOnDisk;\r\n            this.enableInternalDebugLogging = jsonConfig.enableInternalDebugLogging;\r\n            this.enableInternalWarningLogging = jsonConfig.enableInternalWarningLogging;\r\n            this.enableSendLiveMetrics = jsonConfig.enableSendLiveMetrics;\r\n            this.quickPulseHost = jsonConfig.quickPulseHost;\r\n        }\r\n        catch (err) {\r\n            Logging.info(\"Missing or invalid JSON config file: \", err);\r\n        }\r\n    }\r\n}\r\n"]}