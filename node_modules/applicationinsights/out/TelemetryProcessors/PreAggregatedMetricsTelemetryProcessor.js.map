{"version":3,"file":"PreAggregatedMetricsTelemetryProcessor.js","sourceRoot":"","sources":["../../TelemetryProcessors/PreAggregatedMetricsTelemetryProcessor.ts"],"names":[],"mappings":"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","sourcesContent":["import Contracts = require(\"../Declarations/Contracts\");\r\nimport AutoCollecPreAggregatedMetrics = require(\"../AutoCollection/PreAggregatedMetrics\");\r\nimport * as TelemetryType from \"../Declarations/Contracts\";\r\nimport {\r\n    MetricDependencyDimensions,\r\n    MetricExceptionDimensions,\r\n    MetricRequestDimensions,\r\n    MetricTraceDimensions\r\n} from \"../Declarations/Metrics/AggregatedMetricDimensions\";\r\nimport Context = require(\"../Library/Context\");\r\n\r\nexport function preAggregatedMetricsTelemetryProcessor(envelope: Contracts.EnvelopeTelemetry, context: Context): boolean {\r\n    if (AutoCollecPreAggregatedMetrics.isEnabled()) {\r\n        // Increment rate counters\r\n        switch (envelope.data.baseType) {\r\n            case TelemetryType.TelemetryTypeString.Exception:\r\n                const exceptionData: Contracts.ExceptionData = (envelope.data as any).baseData;\r\n                exceptionData.properties = {\r\n                    ...exceptionData.properties,\r\n                    \"_MS.ProcessedByMetricExtractors\": \"(Name:'Exceptions', Ver:'1.1')\"\r\n                };\r\n                let exceptionDimensions: MetricExceptionDimensions = {\r\n                    cloudRoleInstance: envelope.tags[context.keys.cloudRoleInstance],\r\n                    cloudRoleName: envelope.tags[context.keys.cloudRole]\r\n                };\r\n                AutoCollecPreAggregatedMetrics.countException(exceptionDimensions);\r\n                break;\r\n            case TelemetryType.TelemetryTypeString.Trace:\r\n                const traceData: Contracts.TraceTelemetry = (envelope.data as any).baseData;\r\n                traceData.properties = {\r\n                    ...traceData.properties,\r\n                    \"_MS.ProcessedByMetricExtractors\": \"(Name:'Traces', Ver:'1.1')\"\r\n                }\r\n                let traceDimensions: MetricTraceDimensions = {\r\n                    cloudRoleInstance: envelope.tags[context.keys.cloudRoleInstance],\r\n                    cloudRoleName: envelope.tags[context.keys.cloudRole],\r\n                    traceSeverityLevel: Contracts.SeverityLevel[traceData.severity]\r\n                };\r\n                AutoCollecPreAggregatedMetrics.countTrace(traceDimensions);\r\n                break;\r\n            case TelemetryType.TelemetryTypeString.Request:\r\n                const requestData: Contracts.RequestData = (envelope.data as any).baseData;\r\n                requestData.properties = {\r\n                    ...requestData.properties,\r\n                    \"_MS.ProcessedByMetricExtractors\": \"(Name:'Requests', Ver:'1.1')\"\r\n                }\r\n                let requestDimensions: MetricRequestDimensions = {\r\n                    cloudRoleInstance: envelope.tags[context.keys.cloudRoleInstance],\r\n                    cloudRoleName: envelope.tags[context.keys.cloudRole],\r\n                    operationSynthetic: envelope.tags[context.keys.operationSyntheticSource],\r\n                    requestSuccess: requestData.success,\r\n                    requestResultCode: requestData.responseCode\r\n                };\r\n                AutoCollecPreAggregatedMetrics.countRequest(requestData.duration, requestDimensions);\r\n                break;\r\n            case TelemetryType.TelemetryTypeString.Dependency:\r\n                const remoteDependencyData: Contracts.RemoteDependencyData = (envelope.data as any).baseData;\r\n                remoteDependencyData.properties = {\r\n                    ...remoteDependencyData.properties,\r\n                    \"_MS.ProcessedByMetricExtractors\": \"(Name:'Dependencies', Ver:'1.1')\"\r\n                }\r\n                let dependencyDimensions: MetricDependencyDimensions = {\r\n                    cloudRoleInstance: envelope.tags[context.keys.cloudRoleInstance],\r\n                    cloudRoleName: envelope.tags[context.keys.cloudRole],\r\n                    operationSynthetic: envelope.tags[context.keys.operationSyntheticSource],\r\n                    dependencySuccess: remoteDependencyData.success,\r\n                    dependencyType: remoteDependencyData.type,\r\n                    dependencyTarget: remoteDependencyData.target,\r\n                    dependencyResultCode: remoteDependencyData.resultCode\r\n                };\r\n                AutoCollecPreAggregatedMetrics.countDependency(remoteDependencyData.duration, dependencyDimensions);\r\n                break;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n"]}