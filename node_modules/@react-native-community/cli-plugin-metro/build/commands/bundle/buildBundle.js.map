{"version":3,"sources":["../../../src/commands/bundle/buildBundle.ts"],"names":["outputBundle","require","buildBundle","args","ctx","output","config","maxWorkers","resetCache","buildBundleWithConfig","resolver","platforms","indexOf","platform","logger","error","chalk","bold","info","map","x","join","Error","process","env","NODE_ENV","dev","sourceMapUrl","sourcemapOutput","sourcemapUseAbsolutePath","path","basename","requestOpts","entryFile","minify","undefined","unstable_transformProfile","unstableTransformProfile","generateStaticViewConfigs","server","Server","bundle","build","save","outputAssets","getAssets","DEFAULT_BUNDLE_OPTIONS","bundleType","assetsDest","end"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\n// @ts-ignore - no typed definition for the package\nimport Server from 'metro/src/Server';\n// @ts-ignore - no typed definition for the package\nconst outputBundle = require('metro/src/shared/output/bundle');\nimport path from 'path';\nimport chalk from 'chalk';\nimport {CommandLineArgs} from './bundleCommandLineArgs';\nimport type {Config} from '@react-native-community/cli-types';\nimport saveAssets from './saveAssets';\nimport {\n  default as loadMetroConfig,\n  MetroConfig,\n} from '../../tools/loadMetroConfig';\nimport {logger} from '@react-native-community/cli-tools';\n\ninterface RequestOptions {\n  entryFile: string;\n  sourceMapUrl: string | undefined;\n  dev: boolean;\n  minify: boolean;\n  platform: string | undefined;\n  unstable_transformProfile: string | undefined;\n  generateStaticViewConfigs: boolean;\n}\n\nexport interface AssetData {\n  __packager_asset: boolean;\n  fileSystemLocation: string;\n  hash: string;\n  height: number | null;\n  httpServerLocation: string;\n  name: string;\n  scales: number[];\n  type: string;\n  width: number | null;\n  files: string[];\n}\n\nasync function buildBundle(\n  args: CommandLineArgs,\n  ctx: Config,\n  output: typeof outputBundle = outputBundle,\n) {\n  const config = await loadMetroConfig(ctx, {\n    maxWorkers: args.maxWorkers,\n    resetCache: args.resetCache,\n    config: args.config,\n  });\n\n  return buildBundleWithConfig(args, config, output);\n}\n\n/**\n * Create a bundle using a pre-loaded Metro config. The config can be\n * re-used for several bundling calls if multiple platforms are being\n * bundled.\n */\nexport async function buildBundleWithConfig(\n  args: CommandLineArgs,\n  config: MetroConfig,\n  output: typeof outputBundle = outputBundle,\n) {\n  if (config.resolver.platforms.indexOf(args.platform) === -1) {\n    logger.error(\n      `Invalid platform ${\n        args.platform ? `\"${chalk.bold(args.platform)}\" ` : ''\n      }selected.`,\n    );\n\n    logger.info(\n      `Available platforms are: ${config.resolver.platforms\n        .map((x) => `\"${chalk.bold(x)}\"`)\n        .join(\n          ', ',\n        )}. If you are trying to bundle for an out-of-tree platform, it may not be installed.`,\n    );\n\n    throw new Error('Bundling failed');\n  }\n\n  // This is used by a bazillion of npm modules we don't control so we don't\n  // have other choice than defining it as an env variable here.\n  process.env.NODE_ENV = args.dev ? 'development' : 'production';\n\n  let sourceMapUrl = args.sourcemapOutput;\n  if (sourceMapUrl && !args.sourcemapUseAbsolutePath) {\n    sourceMapUrl = path.basename(sourceMapUrl);\n  }\n\n  const requestOpts: RequestOptions = {\n    entryFile: args.entryFile,\n    sourceMapUrl,\n    dev: args.dev,\n    minify: args.minify !== undefined ? args.minify : !args.dev,\n    platform: args.platform,\n    unstable_transformProfile: args.unstableTransformProfile,\n    generateStaticViewConfigs: args.generateStaticViewConfigs,\n  };\n  const server = new Server(config);\n\n  try {\n    const bundle = await output.build(server, requestOpts);\n\n    await output.save(bundle, args, logger.info);\n\n    // Save the assets of the bundle\n    const outputAssets: AssetData[] = await server.getAssets({\n      ...Server.DEFAULT_BUNDLE_OPTIONS,\n      ...requestOpts,\n      bundleType: 'todo',\n    });\n\n    // When we're done saving bundle output and the assets, we're done.\n    return await saveAssets(outputAssets, args.platform, args.assetsDest);\n  } finally {\n    server.end();\n  }\n}\n\nexport default buildBundle;\n"]}