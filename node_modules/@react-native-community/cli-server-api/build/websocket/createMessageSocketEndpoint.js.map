{"version":3,"sources":["../../src/websocket/createMessageSocketEndpoint.ts"],"names":["PROTOCOL_VERSION","parseMessage","data","binary","logger","error","undefined","message","JSON","parse","version","e","isBroadcast","method","id","target","isRequest","isResponse","requestId","clientId","result","createMessageSocketEndpoint","wss","WebSocketServer","noServer","clients","Map","nextClientId","getClientWs","clientWs","get","Error","handleSendBroadcast","broadcasterId","forwarded","params","size","warn","otherId","otherWs","send","stringify","toString","on","handleCaughtError","errorMessage","handleServerRequest","forEach","url","upgradeReq","query","forwardRequest","forwardResponse","set","onCloseHandler","onmessage","delete","onclose","onerror","event","server","broadcast"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport url from 'url';\nimport {Server as WebSocketServer} from 'ws';\nimport {logger} from '@react-native-community/cli-tools';\n\nconst PROTOCOL_VERSION = 2;\n\ntype IdObject = {\n  requestId: string;\n  clientId: string;\n};\n\ntype Message = {\n  version?: string;\n  id?: IdObject;\n  method?: string;\n  target: string;\n  result?: any;\n  error?: Error;\n  params?: Record<string, any>;\n};\n\nfunction parseMessage(data: string, binary: any) {\n  if (binary) {\n    logger.error('Expected text message, got binary!');\n    return undefined;\n  }\n  try {\n    const message = JSON.parse(data);\n    if (message.version === PROTOCOL_VERSION) {\n      return message;\n    }\n    logger.error(\n      `Received message had wrong protocol version: ${message.version}`,\n    );\n  } catch (e) {\n    logger.error(`Failed to parse the message as JSON:\\n${data}`);\n  }\n  return undefined;\n}\n\nfunction isBroadcast(message: Message) {\n  return (\n    typeof message.method === 'string' &&\n    message.id === undefined &&\n    message.target === undefined\n  );\n}\n\nfunction isRequest(message: Message) {\n  return (\n    typeof message.method === 'string' && typeof message.target === 'string'\n  );\n}\n\nfunction isResponse(message: Message) {\n  return (\n    typeof message.id === 'object' &&\n    typeof message.id.requestId !== 'undefined' &&\n    typeof message.id.clientId === 'string' &&\n    (message.result !== undefined || message.error !== undefined)\n  );\n}\n\nexport default function createMessageSocketEndpoint(): {\n  server: WebSocketServer;\n  broadcast: (method: string, params?: Record<string, any>) => void;\n} {\n  const wss = new WebSocketServer({\n    noServer: true,\n  });\n  const clients = new Map();\n  let nextClientId = 0;\n\n  function getClientWs(clientId: string) {\n    const clientWs = clients.get(clientId);\n    if (clientWs === undefined) {\n      throw new Error(\n        `could not find id \"${clientId}\" while forwarding request`,\n      );\n    }\n    return clientWs;\n  }\n\n  function handleSendBroadcast(\n    broadcasterId: string | null,\n    message: Partial<Message>,\n  ) {\n    const forwarded = {\n      version: PROTOCOL_VERSION,\n      method: message.method,\n      params: message.params,\n    };\n    if (clients.size === 0) {\n      logger.warn(\n        `No apps connected. Sending \"${message.method}\" to all React Native apps failed. Make sure your app is running in the simulator or on a phone connected via USB.`,\n      );\n    }\n    for (const [otherId, otherWs] of clients) {\n      if (otherId !== broadcasterId) {\n        try {\n          otherWs.send(JSON.stringify(forwarded));\n        } catch (e) {\n          logger.error(\n            `Failed to send broadcast to client: '${otherId}' ` +\n              `due to:\\n ${e.toString()}`,\n          );\n        }\n      }\n    }\n  }\n\n  wss.on('connection', (clientWs) => {\n    const clientId = `client#${nextClientId++}`;\n\n    function handleCaughtError(message: Message, error: Error) {\n      const errorMessage = {\n        id: message.id,\n        method: message.method,\n        target: message.target,\n        error: message.error === undefined ? 'undefined' : 'defined',\n        params: message.params === undefined ? 'undefined' : 'defined',\n        result: message.result === undefined ? 'undefined' : 'defined',\n      };\n\n      if (message.id === undefined) {\n        logger.error(\n          `Handling message from ${clientId} failed with:\\n${error}\\n` +\n            `message:\\n${JSON.stringify(errorMessage)}`,\n        );\n      } else {\n        try {\n          clientWs.send(\n            JSON.stringify({\n              version: PROTOCOL_VERSION,\n              error,\n              id: message.id,\n            }),\n          );\n        } catch (e) {\n          logger.error(\n            `Failed to reply to ${clientId} with error:\\n${error}` +\n              `\\nmessage:\\n${JSON.stringify(errorMessage)}` +\n              `\\ndue to error: ${e.toString()}`,\n          );\n        }\n      }\n    }\n\n    function handleServerRequest(message: Message) {\n      let result = null;\n      switch (message.method) {\n        case 'getid':\n          result = clientId;\n          break;\n        case 'getpeers':\n          result = {};\n          clients.forEach((otherWs, otherId) => {\n            if (clientId !== otherId) {\n              result[otherId] = url.parse(otherWs.upgradeReq.url, true).query;\n            }\n          });\n          break;\n        default:\n          throw new Error(`unknown method: ${message.method}`);\n      }\n\n      clientWs.send(\n        JSON.stringify({\n          version: PROTOCOL_VERSION,\n          result,\n          id: message.id,\n        }),\n      );\n    }\n\n    function forwardRequest(message: Message) {\n      getClientWs(message.target).send(\n        JSON.stringify({\n          version: PROTOCOL_VERSION,\n          method: message.method,\n          params: message.params,\n          id:\n            message.id === undefined\n              ? undefined\n              : {requestId: message.id, clientId},\n        }),\n      );\n    }\n\n    function forwardResponse(message: Message) {\n      if (!message.id) {\n        return;\n      }\n      getClientWs(message.id.clientId).send(\n        JSON.stringify({\n          version: PROTOCOL_VERSION,\n          result: message.result,\n          error: message.error,\n          id: message.id.requestId,\n        }),\n      );\n    }\n\n    clients.set(clientId, clientWs);\n    const onCloseHandler = () => {\n      clientWs.onmessage = () => {};\n      clients.delete(clientId);\n    };\n    clientWs.onclose = onCloseHandler;\n    clientWs.onerror = onCloseHandler;\n    clientWs.onmessage = (event: any) => {\n      const message = parseMessage(event.data, event.binary);\n      if (message === undefined) {\n        logger.error('Received message not matching protocol');\n        return;\n      }\n\n      try {\n        if (isBroadcast(message)) {\n          handleSendBroadcast(clientId, message);\n        } else if (isRequest(message)) {\n          if (message.target === 'server') {\n            handleServerRequest(message);\n          } else {\n            forwardRequest(message);\n          }\n        } else if (isResponse(message)) {\n          forwardResponse(message);\n        } else {\n          throw new Error('Invalid message, did not match the protocol');\n        }\n      } catch (e) {\n        handleCaughtError(message, e.toString());\n      }\n    };\n  });\n\n  return {\n    server: wss,\n    broadcast: (method: string, params?: Record<string, any>) => {\n      handleSendBroadcast(null, {method, params});\n    },\n  };\n}\n"]}