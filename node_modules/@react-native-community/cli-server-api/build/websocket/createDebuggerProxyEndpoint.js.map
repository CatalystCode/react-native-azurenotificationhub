{"version":3,"sources":["../../src/websocket/createDebuggerProxyEndpoint.ts"],"names":["createDebuggerProxyEndpoint","WebSocketServer","ws","Server","wss","noServer","debuggerSocket","clientSocket","send","dest","message","e","logger","warn","debuggerSocketCloseHandler","close","clientSocketCloseHandler","JSON","stringify","method","on","socket","request","url","indexOf","onerror","onclose","onmessage","data","server","isDebuggerConnected"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @format\n */\n\nimport ws from 'ws';\nimport {logger} from '@react-native-community/cli-tools';\n\nexport default function createDebuggerProxyEndpoint(): {\n  server: ws.Server;\n  isDebuggerConnected: () => boolean;\n} {\n  const WebSocketServer = ws.Server;\n  const wss = new WebSocketServer({\n    noServer: true,\n  });\n\n  let debuggerSocket: ws | null;\n  let clientSocket: ws | null;\n\n  function send(dest: ws | null, message: ws.Data) {\n    if (!dest) {\n      return;\n    }\n\n    try {\n      dest.send(message);\n    } catch (e) {\n      logger.warn(e);\n      // Sometimes this call throws 'not opened'\n    }\n  }\n\n  const debuggerSocketCloseHandler = () => {\n    debuggerSocket = null;\n    if (clientSocket) {\n      clientSocket.close(1011, 'Debugger was disconnected');\n    }\n  };\n\n  const clientSocketCloseHandler = () => {\n    clientSocket = null;\n    send(debuggerSocket, JSON.stringify({method: '$disconnected'}));\n  };\n\n  wss.on('connection', (socket, request) => {\n    const {url} = request;\n\n    if (url && url.indexOf('role=debugger') > -1) {\n      if (debuggerSocket) {\n        socket.close(1011, 'Another debugger is already connected');\n        return;\n      }\n      debuggerSocket = socket;\n      if (debuggerSocket) {\n        debuggerSocket.onerror = debuggerSocketCloseHandler;\n        debuggerSocket.onclose = debuggerSocketCloseHandler;\n        debuggerSocket.onmessage = ({data}) => send(clientSocket, data);\n      }\n    } else if (url && url.indexOf('role=client') > -1) {\n      if (clientSocket) {\n        clientSocket.onerror = () => {};\n        clientSocket.onclose = () => {};\n        clientSocket.onmessage = () => {};\n        clientSocket.close(1011, 'Another client connected');\n      }\n      clientSocket = socket;\n      clientSocket.onerror = clientSocketCloseHandler;\n      clientSocket.onclose = clientSocketCloseHandler;\n      clientSocket.onmessage = ({data}) => send(debuggerSocket, data);\n    } else {\n      socket.close(1011, 'Missing role param');\n    }\n  });\n\n  return {\n    server: wss,\n    isDebuggerConnected() {\n      return !!debuggerSocket;\n    },\n  };\n}\n"]}